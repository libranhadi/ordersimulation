<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Order Cart</title>
    <script src="https://unpkg.com/vue@3"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>

<body class="p-5" style="background:#f2f2f2;">
<div id="cartApp" class="container">

    <h2 class="mb-4">Order Cart</h2>

    <div class="card p-3 mb-4 shadow">
        <h5>Customer</h5>

        <label>Name</label>
        <input v-model="customer.name" class="form-control mb-2">

        <label>Address</label>
        <input v-model="customer.address" class="form-control">
    </div>

    <table class="table table-bordered bg-white shadow">
        <thead class="table-light">
            <tr>
                <th></th>
                <th>Name</th>
                <th>Type</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Total</th>
            </tr>
        </thead>

        <tbody>
            <tr v-for="item in cart" :key="item.productId">
                <td>
                    <button class="btn btn-sm btn-danger" @click="removeItem(item.productId)">X</button>
                </td>
                <td>{{ item.name }}</td>
                <td>{{ item.type }}</td>
                <td>Rp {{ format(item.price) }}</td>
                <td>{{ item.qty }}</td>
                <td>Rp {{ format(item.price * item.qty) }}</td>
            </tr>
        </tbody>
    </table>

    <div class="text-end h5 mb-4">
        Total: <strong>Rp {{ format(totalAmount) }}</strong>
    </div>

    <button class="btn btn-primary btn-lg" @click="placeOrder">Place Order</button>
    <a href="/products" class="btn btn-secondary ms-2">Back</a>

</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            cart: [],
            customer: {
                name: "",
                address: ""
            }
        };
    },

    computed: {
        totalAmount() {
            return this.cart.reduce((sum, item) => sum + item.price * item.qty, 0);
        }
    },

    mounted() {
        this.loadCart();
    },

    methods: {
        format(num) { return num.toLocaleString("id-ID"); },

        async loadCart() {
            const res = await fetch("/api/cart");
            this.cart = await res.json();
        },

        async removeItem(productId) {
            await fetch("/api/cart/" + productId, { method: "DELETE" });
            this.loadCart();
        },

        async placeOrder() {
            const payload = {
                customerName: this.customer.name,
                customerAddress: this.customer.address,
                items: this.cart.map(i => ({
                    productId: i.productId,
                    qty: i.qty
                }))
            };

            await fetch("/api/orders", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            alert("Order placed!");
        }
    }
}).mount("#cartApp");
</script>

</body>
</html>
